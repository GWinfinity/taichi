# FlagOS æ”¯æŒ Taichi é›†æˆæ–¹æ¡ˆæ€»ç»“

## é¡¹ç›®æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†å¦‚ä½•å°† **FlagOS**ï¼ˆé¢å‘å¤šç§ AI èŠ¯ç‰‡çš„ç»Ÿä¸€å¼€æºç³»ç»Ÿè½¯ä»¶æ ˆï¼‰ä¸ **Taichi**ï¼ˆé«˜æ€§èƒ½å¹¶è¡Œç¼–ç¨‹è¯­è¨€ï¼‰é›†æˆï¼Œä»¥å®ç° Taichi å¯¹å¤šç§å›½äº§ AI èŠ¯ç‰‡çš„æ”¯æŒã€‚

## æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Taichi Frontend                               â”‚
â”‚                     (Python API / DSL)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Taichi Compiler                                â”‚
â”‚           (AST Transformation / SNode / Optimization)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  LLVM   â”‚ â”‚  CUDA   â”‚ â”‚  AMDGPU â”‚ â”‚    FlagOS Backend        â”‚   â”‚
â”‚  â”‚ (x64)   â”‚ â”‚ (NVIDIA)â”‚ â”‚  (AMD)  â”‚ â”‚  (å¤šèŠ¯ç‰‡ç»Ÿä¸€åç«¯)         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                          Taichi Codegen                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        FlagOS è½¯ä»¶æ ˆ                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                     FlagTree ç»Ÿä¸€ç¼–è¯‘å™¨                         â”‚  â”‚
â”‚  â”‚        (MLIR/LLVM-based Compiler for AI Chips)                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                  â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  MLU    â”‚ â”‚  Ascend â”‚ â”‚  DCU    â”‚ â”‚  GCU    â”‚ â”‚   ...       â”‚    â”‚
â”‚  â”‚(å¯’æ­¦çºª)  â”‚ â”‚(åä¸º)   â”‚ â”‚(æµ·å…‰)   â”‚ â”‚(ç‡§åŸ)   â”‚ â”‚ å…¶ä»–èŠ¯ç‰‡     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å·²å®Œæˆçš„å®ç°

### 1. æ¶æ„å®šä¹‰ (`taichi/inc/archs.inc.h`)

```cpp
// æ·»åŠ  FlagOS æ¶æ„æ”¯æŒ
PER_ARCH(flagos)  // FlagOS: Unified AI Chip Backend
```

### 2. æ¶æ„å‡½æ•° (`taichi/rhi/arch.cpp`)

- æ·»åŠ  `flagos` åˆ° `arch_uses_llvm()` å‡½æ•°
- æ·»åŠ  `flagos` åˆ° `default_simd_width()` å‡½æ•°

### 3. RHI è®¾å¤‡å±‚ (`taichi/rhi/flagos/`)

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `flagos_device.h` | FlagOS è®¾å¤‡å¤´æ–‡ä»¶ï¼Œå®šä¹‰ `FlagosDevice` ç±» |
| `flagos_device.cpp` | è®¾å¤‡å®ç°ï¼šå†…å­˜ç®¡ç†ã€æ•°æ®ä¼ è¾“ã€å†…æ ¸å¯åŠ¨ |
| `CMakeLists.txt` | æ„å»ºé…ç½® |

**å…³é”®ç‰¹æ€§ï¼š**
- ç»§æ‰¿ `LlvmDevice`ï¼Œå¤ç”¨ LLVM åŸºç¡€è®¾æ–½
- æ”¯æŒå¤šç§èŠ¯ç‰‡é…ç½®ï¼ˆmlu370, ascend910, dcu, gcu ç­‰ï¼‰
- ç¯å¢ƒå˜é‡ `TI_FLAGOS_CHIP` æŒ‡å®šç›®æ ‡èŠ¯ç‰‡

### 4. ä»£ç ç”Ÿæˆå±‚ (`taichi/codegen/flagos/`)

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `codegen_flagos.h` | ä»£ç ç”Ÿæˆå™¨å¤´æ–‡ä»¶ |
| `codegen_flagos.cpp` | LLVM IR ç”Ÿæˆå®ç° |
| `CMakeLists.txt` | æ„å»ºé…ç½® |

**å…³é”®ç‰¹æ€§ï¼š**
- ç»§æ‰¿ `TaskCodeGenLLVM`
- é’ˆå¯¹ AI èŠ¯ç‰‡ä¼˜åŒ–çš„å¹¶è¡Œå¾ªç¯ç”Ÿæˆ
- æ”¯æŒ FlagOS ç‰¹å®šæ•°å­¦åº“è°ƒç”¨

### 5. ç¨‹åºå®ç°å±‚ (`taichi/runtime/program_impls/flagos/`)

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `flagos_program.h` | ç¨‹åºå®ç°å¤´æ–‡ä»¶ |
| `flagos_program.cpp` | FlagOS è¿è¡Œæ—¶é›†æˆ |
| `CMakeLists.txt` | æ„å»ºé…ç½® |

### 6. ç¼–è¯‘é…ç½® (`taichi/program/compile_config.h`)

```cpp
// FlagOS backend options:
std::string flagos_chip{"generic"};  // Target chip: mlu370, ascend910, dcu, etc.
```

### 7. Python API (`taichi/python/export_lang.cpp`)

```cpp
.def_readwrite("flagos_chip", &CompileConfig::flagos_chip);
```

### 8. CMake æ„å»ºç³»ç»Ÿ

**`cmake/TaichiCore.cmake`:**
```cmake
option(TI_WITH_FLAGOS "Build with the FlagOS backend" OFF)

if (TI_WITH_FLAGOS)
    add_subdirectory(taichi/rhi/flagos)
    add_subdirectory(taichi/codegen/flagos)
    add_subdirectory(taichi/runtime/program_impls/flagos)

    target_link_libraries(${CORE_LIBRARY_NAME} PRIVATE flagos_rhi)
    target_link_libraries(${CORE_LIBRARY_NAME} PRIVATE flagos_codegen)
    target_link_libraries(${CORE_LIBRARY_NAME} PRIVATE flagos_program)
endif()
```

### 9. ç¤ºä¾‹ç¨‹åº (`examples/flagos/`)

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `fractal_flagos.py` | Julia é›†åˆåˆ†å½¢è®¡ç®—ç¤ºä¾‹ |
| `matmul_flagos.py` | çŸ©é˜µä¹˜æ³•åŸºå‡†æµ‹è¯• |
| `README.md` | ä½¿ç”¨æ–‡æ¡£ |

## ä½¿ç”¨æ–¹å¼

### ç¯å¢ƒå˜é‡æ–¹å¼

```bash
# è®¾ç½®ç›®æ ‡èŠ¯ç‰‡
export TI_FLAGOS_CHIP=mlu370

# è¿è¡Œç¨‹åº
python my_taichi_program.py
```

### ä»£ç é…ç½®æ–¹å¼

```python
import taichi as ti

# åˆå§‹åŒ– FlagOS åç«¯
ti.init(arch=ti.flagos, flagos_chip="mlu370")

# å®šä¹‰ Taichi å†…æ ¸
@ti.kernel
def my_kernel():
    for i in range(1000000):
        # å¹¶è¡Œè®¡ç®—
        pass

my_kernel()
```

## æ”¯æŒçš„èŠ¯ç‰‡åˆ—è¡¨

| èŠ¯ç‰‡ | å‚å•† | çŠ¶æ€ |
|------|------|------|
| MLU370 | å¯’æ­¦çºª (Cambricon) | è®¡åˆ’æ”¯æŒ |
| MLU590 | å¯’æ­¦çºª (Cambricon) | è®¡åˆ’æ”¯æŒ |
| Ascend910 | åä¸º (Huawei) | è®¡åˆ’æ”¯æŒ |
| Ascend310 | åä¸º (Huawei) | è®¡åˆ’æ”¯æŒ |
| DCU | æµ·å…‰ (Hygon) | è®¡åˆ’æ”¯æŒ |
| GCU | ç‡§åŸ (Enflame) | è®¡åˆ’æ”¯æŒ |
| Generic | é€šç”¨ | å·²å®ç° (stub) |

## æ„å»ºæ­¥éª¤

### 1. å®‰è£…ä¾èµ–

```bash
# å®‰è£… FlagOS SDK
# è¯·å‚è€ƒ FlagOS å®˜æ–¹æ–‡æ¡£: https://github.com/flagos-ai

# å®‰è£… FlagTree ç¼–è¯‘å™¨
# è¯·å‚è€ƒ FlagTree å®˜æ–¹æ–‡æ¡£: https://github.com/flagos-ai/flagtree
```

### 2. æ„å»º Taichi

```bash
# å…‹éš† Taichi
git clone https://github.com/taichi-dev/taichi.git
cd taichi

# åˆ›å»ºæ„å»ºç›®å½•
mkdir build && cd build

# é…ç½® CMake
cmake .. \
    -DTI_WITH_FLAGOS=ON \
    -DTI_WITH_LLVM=ON \
    -DCMAKE_BUILD_TYPE=Release \
    -DFlagOS_ROOT=/path/to/flagos-sdk  # å¦‚æœä¸åœ¨æ ‡å‡†è·¯å¾„

# ç¼–è¯‘
make -j$(nproc)

# å®‰è£…
pip install -e ..
```

### 3. éªŒè¯å®‰è£…

```python
import taichi as ti

# æ£€æŸ¥ FlagOS æ˜¯å¦å¯ç”¨
print(hasattr(ti, 'flagos'))  # åº”è¯¥è¾“å‡º True

# åˆå§‹åŒ–å¹¶è¿è¡Œ
ti.init(arch=ti.flagos, flagos_chip="generic")

@ti.kernel
def test_kernel():
    for i in range(100):
        pass

test_kernel()
print("FlagOS backend working!")
```

## ä¸ FlagOS ç»„ä»¶çš„é›†æˆç‚¹

### 1. FlagTree ç»Ÿä¸€ç¼–è¯‘å™¨

```cpp
// FlagTree API é›†æˆç¤ºä¾‹
namespace flagos {

class FlagTreeCompiler {
 public:
  // ç¼–è¯‘ LLVM IR åˆ°ç›®æ ‡èŠ¯ç‰‡ä»£ç 
  std::vector<uint8_t> compile(const std::string &llvm_ir,
                               const std::string &target_chip);

  // è·å–æ”¯æŒçš„èŠ¯ç‰‡åˆ—è¡¨
  std::vector<std::string> get_supported_chips();
};

} // namespace flagos
```

**é›†æˆä½ç½®ï¼š** `taichi/codegen/flagos/codegen_flagos.cpp`

### 2. FlagGems ç®—å­åº“ï¼ˆå¯é€‰ï¼‰

å¯ä»¥ä½¿ç”¨ FlagGems æä¾›çš„é«˜æ€§èƒ½ç®—å­æ›¿æ¢ Taichi çš„é»˜è®¤å®ç°ã€‚

### 3. FlagCX é€šä¿¡åº“ï¼ˆå¤šå¡æ‰©å±•ï¼‰

æœªæ¥å¯ä»¥é›†æˆ FlagCX å®ç°å¤šå¡å¹¶è¡Œè®¡ç®—ã€‚

## å¼€å‘è·¯çº¿å›¾

### Phase 1: åŸºç¡€æ¶æ„ âœ… (å·²å®Œæˆ)
- [x] æ·»åŠ  flagos æ¶æ„å®šä¹‰
- [x] å®ç°åŸºç¡€ FlagosDevice
- [x] é›†æˆ LLVM ä»£ç ç”Ÿæˆ
- [x] æ„å»ºç³»ç»Ÿé›†æˆ

### Phase 2: FlagTree é›†æˆ ğŸ”„ (è¿›è¡Œä¸­)
- [ ] å®ç° FlagTree ç¼–è¯‘å™¨æ¥å£
- [ ] æ”¯æŒå†…æ ¸ç¼–è¯‘å’ŒåŠ è½½
- [ ] å®ç°åŸºç¡€æ•°å­¦è¿ç®—

### Phase 3: èŠ¯ç‰‡æ”¯æŒ
- [ ] å¯’æ­¦çºª MLU ç³»åˆ—
- [ ] åä¸ºæ˜‡è…¾ Ascend ç³»åˆ—
- [ ] æµ·å…‰ DCU ç³»åˆ—
- [ ] ç‡§åŸ GCU ç³»åˆ—

### Phase 4: é«˜çº§ç‰¹æ€§
- [ ] ç¨€ç–æ•°æ®ç»“æ„ (SNode) ä¼˜åŒ–
- [ ] è‡ªåŠ¨å¾®åˆ†æ”¯æŒ
- [ ] AOT (Ahead-of-Time) ç¼–è¯‘
- [ ] æ€§èƒ½åˆ†æå’Œè°ƒä¼˜å·¥å…·

## æ–‡ä»¶æ¸…å•

### æ–°åˆ›å»ºçš„æ–‡ä»¶

```
taichi/
â”œâ”€â”€ inc/archs.inc.h (ä¿®æ”¹)
â”œâ”€â”€ rhi/
â”‚   â”œâ”€â”€ arch.cpp (ä¿®æ”¹)
â”‚   â””â”€â”€ flagos/
â”‚       â”œâ”€â”€ flagos_device.h
â”‚       â”œâ”€â”€ flagos_device.cpp
â”‚       â””â”€â”€ CMakeLists.txt
â”œâ”€â”€ codegen/
â”‚   â””â”€â”€ flagos/
â”‚       â”œâ”€â”€ codegen_flagos.h
â”‚       â”œâ”€â”€ codegen_flagos.cpp
â”‚       â””â”€â”€ CMakeLists.txt
â”œâ”€â”€ runtime/program_impls/
â”‚   â””â”€â”€ flagos/
â”‚       â”œâ”€â”€ flagos_program.h
â”‚       â”œâ”€â”€ flagos_program.cpp
â”‚       â””â”€â”€ CMakeLists.txt
â”œâ”€â”€ program/
â”‚   â””â”€â”€ compile_config.h (ä¿®æ”¹)
â””â”€â”€ python/
    â””â”€â”€ export_lang.cpp (ä¿®æ”¹)

cmake/
â””â”€â”€ TaichiCore.cmake (ä¿®æ”¹)

examples/flagos/
â”œâ”€â”€ fractal_flagos.py
â”œâ”€â”€ matmul_flagos.py
â””â”€â”€ README.md

docs/
â””â”€â”€ flagos_integration_design.md
```

## åç»­å·¥ä½œ

### éœ€è¦ FlagOS ç¤¾åŒºæ”¯æŒ

1. **FlagTree C++ API**: æä¾›ç¨³å®šçš„ç¼–è¯‘å™¨æ¥å£
2. **è¿è¡Œæ—¶åº“**: æä¾›èŠ¯ç‰‡ç‰¹å®šçš„å†…å­˜ç®¡ç†å’Œå†…æ ¸å¯åŠ¨ API
3. **æ•°å­¦åº“**: æä¾›ä¼˜åŒ–çš„è®¾å¤‡ç«¯æ•°å­¦å‡½æ•°
4. **æ–‡æ¡£å’Œç¤ºä¾‹**: æä¾›èŠ¯ç‰‡ç‰¹å®šçš„ä¼˜åŒ–æŒ‡å—

### éœ€è¦ Taichi ç¤¾åŒºæ”¯æŒ

1. **ä»£ç å®¡æŸ¥**: å®¡æŸ¥å¹¶åˆå¹¶ FlagOS åç«¯ä»£ç 
2. **CI/CD**: æ·»åŠ  FlagOS åç«¯åˆ°æŒç»­é›†æˆç³»ç»Ÿ
3. **æ–‡æ¡£**: æ›´æ–°å®˜æ–¹æ–‡æ¡£æ·»åŠ  FlagOS ä½¿ç”¨è¯´æ˜
4. **æµ‹è¯•**: æ·»åŠ  FlagOS åç«¯æµ‹è¯•ç”¨ä¾‹

## å‚è€ƒé“¾æ¥

- [FlagOS GitHub](https://github.com/flagos-ai)
- [FlagTree ç¼–è¯‘å™¨](https://github.com/flagos-ai/flagtree)
- [FlagGems ç®—å­åº“](https://github.com/flagos-ai/FlagGems)
- [Taichi å®˜æ–¹æ–‡æ¡£](https://docs.taichi-lang.org)
- [Taichi GitHub](https://github.com/taichi-dev/taichi)

## è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»ï¼š
- FlagOS ç¤¾åŒº: https://github.com/flagos-ai/community
- Taichi ç¤¾åŒº: https://github.com/taichi-dev/taichi/discussions
